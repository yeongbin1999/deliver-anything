name: Auto PR Title from Issue

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  issues: read
  pull-requests: write

jobs:
  set-pr-title:
    runs-on: ubuntu-latest
    steps:
      - name: Set PR title same as issue title (no linking)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            // 봇 PR 스킵
            const botLogins = new Set(['dependabot[bot]']);
            if (botLogins.has(pr.user.login)) return;

            const branch = pr.head.ref; // ex) feat/be/123

            // 우리 브랜치 패턴만 처리
            if (!/^(feat|fix|refactor|docs|chore|test)\/(fe|be|infra)\/\d+$/.test(branch)) {
              core.info(`Skip: branch "${branch}" not matching pattern`);
              return;
            }

            // 브랜치에서 이슈 번호
            const m = branch.match(/(\d+)$/);
            if (!m) return;
            const issueNumber = Number(m[1]);

            // 이슈 조회
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });

            const issueTitle = (issue.data.title || '').trim();
            if (!issueTitle) return;

            // ✅ 제목만 동기화 (번호/링크 붙이지 않음)
            const desiredTitle = issueTitle;

            if (desiredTitle !== pr.title) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                title: desiredTitle
              });
              core.info(`PR title updated → ${desiredTitle}`);
            } else {
              core.info('PR title already up-to-date');
            }

            // ❌ PR 본문에는 이슈 링크 추가하지 않음 (Projects에 PR 노출 방지)