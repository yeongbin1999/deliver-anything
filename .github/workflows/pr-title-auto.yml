name: Auto PR Title from Issue

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  issues: read
  pull-requests: write

jobs:
  set-pr-title:
    runs-on: ubuntu-latest
    steps:
      - name: Set PR title same as issue title + number
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            // 1) Dependabot ë“± ë´‡ PRì€ íŒ¨ìŠ¤
            const botLogins = new Set(['dependabot[bot]']);
            if (botLogins.has(pr.user.login)) {
              console.log('â„¹ï¸ Bot PR detected, skipping');
              return;
            }

            const branch = pr.head.ref; // ex) feat/be/123
            // 2) ìš°ë¦¬ ë¸Œëœì¹˜ ì»¨ë²¤ì…˜ì´ ì•„ë‹ˆë©´ ìŠ¤í‚µ(ì‹¤ìˆ˜ ë°©ì§€)
            const branchOK = /^(feat|fix|refactor|docs|chore|test)\/(fe|be|infra)\/\d+$/.test(branch);
            if (!branchOK) {
              console.log(`â„¹ï¸ Branch "${branch}" does not match our pattern; skipping`);
              return;
            }

            // 3) ë¸Œëœì¹˜ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ (ë§ˆì§€ë§‰ ì„¸ê·¸ë¨¼íŠ¸ ìˆ«ì)
            const m = branch.match(/(?:\/|^)(\d+)$/);
            if (!m) {
              console.log(`âŒ Could not extract issue number from "${branch}"`);
              return;
            }
            const issueNumber = Number(m[1]);

            // 4) ì´ìŠˆ ì¡°íšŒ (404ë©´ ìŠ¤í‚µ)
            let issue;
            try {
              issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });
            } catch (error) {
              if (error.status === 404) {
                console.log(`âŒ Issue #${issueNumber} not found; skipping`);
                return;
              }
              throw error;
            }

            const issueTitle = (issue.data.title || '').trim();
            if (!issueTitle) {
              console.log(`âŒ Issue #${issueNumber} has empty title; skipping`);
              return;
            }

            // 5) PR ì œëª© ë™ê¸°í™”: "<ì´ìŠˆì œëª©> (#ë²ˆí˜¸)"
            const desiredTitle = `${issueTitle} (#${issueNumber})`;
            if (desiredTitle !== pr.title) {
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                title: desiredTitle
              });
              console.log(`âœ… PR title updated â†’ ${desiredTitle}`);
            } else {
              console.log('â„¹ï¸ PR title already up-to-date');
            }

            // 6) (ì˜µì…˜) PR ë³¸ë¬¸ì— ì´ìŠˆ ë§í¬ ì—†ìœ¼ë©´ ì¶”ê°€
            const body = pr.body || '';
            if (!new RegExp(`\\(#${issueNumber}\\)`).test(body) && !new RegExp(`#${issueNumber}(\\b|$)`).test(body)) {
              const appended = `${body}\n\nLinked: #${issueNumber}`.trim();
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body: appended
              });
              console.log(`ğŸ“ Appended issue link to PR body`);
            }